# card2b — API по работе с шаблонами

Шаблон - основа для выпускаемых карточек. Он позволяет задать внешний вид карточек (тип разметки, поля и их содержание, изображения),
определить структуру данных, значения по умолчанию, а так же технические настройки — всё это наследуются выпускаемыми картами.

Вы можете создавать несколько шаблонов через [кабинет](https://card2b.com/cabinet/templates) (в зависимости от своих потребностей) и выпускать карты по каждому из них.

При изменении шаблона изменятся и унаследованные от него карточки (кроме переопределённых полей).
Такая концепция очень удобна для централизованного управления общей частью.
Например: если у вас изменился логотип или акция, вам не придётся менять их на каждой карточке — достаточно внести изменение в шаблон.


<a name="api_template_get"></a>
## Запросить информацию о шаблоне
Запрос возвращает основные сведения о текущем состоянии шаблона: настройки, данные по умолчанию, количество выпущенных и 
установленных карт (которые наследуются от запрашиваемого шаблона), историю версий шаблона
```shell
  [GET] /api/template/{template_id} 
```
### Параметры запроса
* **template_id** *number* — идентификатор шаблона (отображается на вкладке API созданного шаблона)

### Параметры ответа
* **Object** *[объект шаблона](./working-with-api.md#template)* — полные сведения о шаблоне

Пример ответа:
```json
{
  "template_id": 64,
  "pass_type": "storeCard",
  "title": "MyJuice - копилки",
  "description": "Дисконтная карта программы лояльности",
  "template_settings": {
    "...": "..."
  },
  "default_data": {
    "bonus": "0.00",
    "status": "Синий",
    "client_id": "00000",
    "owner_name": "-"
  },
  "create_time": "2017-09-18T12:33:45.620Z",
  "update_time": "2018-03-15T18:09:06.737Z",
  "deactivated": false,
  "cards_issued": 569,
  "cards_installed": 301,
  "versions": [
    {
      "v_num": 1,
      "valid_from": "2017-09-18T12:33:45.620Z"
    },
    {
      "v_num": 2,
      "valid_from": "2018-03-13T16:48:13.642Z"
    }
  ]
}
```

<a name="api_template_cards"></a>
## Список карт, выпущеных по шаблону
Если вам требуется получить список всех карт, выпущенных по шаблону. Кроме того, метод возаращает количество выпущенных карт и количество установок на устройства. 
```shell
[GET] /api/template/{template_id}/cards?limit={limit}
```
### Параметры запроса
* **template_id** *number* — id шаблона
* **limit** *number* *optional, по умолчанию 100* — сколько карточек вернуть; сортировка — обратная хронологическая, т.е. возвращаются *limit* последних выпущенных карточек

### Параметры ответа
* **cards_issued** *number* - количество выпущенных карт
* **cards_installed** *number* — количество установленных карт
* **cards** *array of [объект карточки](./working-with-api.md#card)* - карточки шаблона

Ответ: 

```json
{
  "cards_issued": 569,
  "cards_installed": 301,
  "cards": [
    { /* карточка */ },         
    { /* карточка */ }
  ]
}
```


<a name="api_template_update"></a>
## Изменение шаблона
Если требуется изменить шаблон: название, описание, значения переменных по умолчанию.
```shell
[POST] /api/template/{template_id}/update
```
### Параметры запроса
* **template_id** *number* — id шаблона
* *POST* **title** *string* *optional* — название для отображения в кабинете; не версионируется
* *POST* **description** *string* *optional* — подробное описание для отображения в кабинете; не версионируется
* *POST* **default_data** *object* *optional* — значения параметров по умолчанию (см. [концепцию](./basic-concepts.md#дефолтные-данные-и-переопределение))

> Если **default_data** меняется, то создаётся не только новая версия шаблона, но и новая версия всех выпущенных карточек.

### Параметры ответа
* **template_id** *number* - id шаблона
* **changed** *boolean* - Статус изменения. **true**, если были изменены хоть какие-то свойства (даже title)
* **cards_reissue_needed** - Влияние на выпущенные карточки. **true**, если изменение шаблона влияет на выпущенные карточки

Пример ответа:
```json
{
  "template_id": 123,
  "changed": true,
  "cards_reissue_needed": true
}
```



<a name="api_template_reissue"></a>
## Форсированная рассылка новых версий карточек
Если обновление шаблона влияет на выпущенные карточки(**cards_reissue_needed** === true), то у Вас есть выбор:
1. Оставить всё как есть и тогда обновления шаблона прилетят на устройства с ближайшим обновлением карточки (индивидуально для каждой карточки);
2. Вызвать метод reissue, тогда обновления шаблона прилетят на устройства незамедлительно (массовая операция).
Руководствуйтесь критичностью изменений шаблона.

```shell
[POST] /api/template/{template_id}/reissue
```
### Параметры запроса
* **template_id** *number* — id шаблона

### Параметры ответа
* **template_id** *number* - id шаблона
* **changed** *boolean* - Статус изменения. **true**, если были изменены хоть какие-то свойства (даже title)
* **cards_reissue_needed** - Влияние на выпущенные карточки. **true**, если изменение шаблона влияет на выпущенные карточки

Пример ответа:

```json
{
  "template_id": 123,
  "changed": true,              // true, если есть (и была перевыпущена) хоть одна карточка 
  "cards_reissue_needed": false
}
```



<a name="api_template_notify"></a>
##  Отправка уведомления на установленные карты
Массовая рассылка текстового push-сообщения на все установленные карты.
Аналог [/api/card/notify](./cards.md#api_card_notify) - для конкретной карты.
```shell
[POST] /api/template/{template_id}/notify
```
### Параметры запроса
* **template_id** *number* — id шаблона
* *POST* **notify_txt** *string* — текст уведомления

Аналог [/api/card/notify](./cards.md#api_card_notify), только сразу на все установленные карточки.

> Сейчас notify_text пока не поддерживает переменные. Если вам нужна очень нужна эта фича, напишите на dev@card2b.com или пишите issues.

### Параметры ответа
* **template_id** *number* - id шаблона
* **changed** *boolean* - Статус изменения. **true**, если были изменены хоть какие-то свойства (даже title)
* **cards_reissue_needed** - Влияние на выпущенные карточки. **true**, если изменение шаблона влияет на выпущенные карточки

Пример ответа:

```json
{
  "template_id": 123,
  "changed": true,              // true, если уведомления были отправлены 
  "cards_reissue_needed": false
}
```

 
 
<a name="api_template_deactivate"></a>
## Блокировать шаблон
После блокировки нельзя будет выпустить новую карточку по шаблону. Все существующие продолжат работать, как и раньше. Что-то вроде перевода шаблона в архив.
```shell
[POST] /api/template/{template_id}/deactivate
```
### Параметры запроса
* **template_id** *number* — id шаблона

### Параметры ответа
* **template_id** *number* - id шаблона
* **changed** *boolean* - Статус изменения. **true**, если были изменены хоть какие-то свойства (даже title)
* **cards_reissue_needed** - Влияние на выпущенные карточки. **true**, если изменение шаблона влияет на выпущенные карточки

Пример ответа:

```json
{
  "template_id": 123,
  "changed": true,              // true, если шаблон был активен, а стал заблокирован 
  "cards_reissue_needed": false
}
```
  

<a name="api_template_activate"></a>
## Разблокировать шаблон
Обратное действие для deactivate. Снимает запрет на выпуск карточек по шаблону.
```shell
[POST] /api/template/{template_id}/activate
```

### Параметры запроса
* **template_id** *number* — id шаблона
### Параметры ответа
* **template_id** *number* - id шаблона
* **changed** *boolean* - Статус изменения. **true**, если были изменены хоть какие-то свойства (даже title)
* **cards_reissue_needed** - Влияние на выпущенные карточки. **true**, если изменение шаблона влияет на выпущенные карточки

Пример ответа:

``` js
{
  "template_id": 123,
  "changed": true,              // true, если шаблон был активен, а стал заблокирован
  "cards_reissue_needed": false
}
```


<a name="api_template_stat"></a>
## Статистика изменений данных
Если требуется узнать как менялось поле, например сумма бонусов по всем выпущенным картам.
``` shell
[GET] /api/template/{template_id}/stat?...
```
### Параметры запроса
* **template_id** *number* — id шаблона
* **timeFrom** *unix timestamp* — с какого момента времени
* **timeTo** *unix timestamp* — до какого момента времени
* **field** *string* — ключ из *default_data*; значения должны быть числовыми (т.е. можно получить статистику по bonus, но нельзя по status из примеров выше)
* **step** *number* — с каким шагом, в минутах
* **aggMethod** *string* — один из `sum, avg, max, min, count` — метод агрегации, когда несколько карточек попадают в интервал

Пример запроса:
запросим *сумму* *bonus*'ов всех карточек *123*-го шаблона с *1 ноября* по *1 марта* с шагом в *неделю*:

```
GET /api/template/123/stat?field=bonus&timeFrom=1509483600&timeTo=1519851600&step=10080&aggMethod=sum
```  

Ответ:

``` js
{
  "template_id": 123,
  "field": "bonus",
  "stepPoints": [83,131,181,198,154,271,261,339,413,419,528,567,625,479,435,615,645,651]
}
```


<a name="api_template_get_vnum"></a>
## GET /api/template/{template_id}?v_num={v_num} — получить версию шаблона

``` json
  [GET] /api/template/{template_id}?v_num={v_num}
```

- **template_id** *number* — id шаблона
- **v_num** *number* — число от 1 до количества версий шаблона

Ответ: [объект версии шаблона](./working-with-api.md#template-version).

<a name="api_template_vtime"></a>
## GET /api/template/{template_id}?v_time={v_time} — получить состояние на момент времени

- **template_id** *number* — id шаблона
- **v_time** *number* — unix timestamp, на который нужно вернуть состояние (не ранее, чем *create_time* шаблона)

Ответ: [объект версии шаблона](./working-with-api.md#template-version).



Для визуализации статистики — по любым полям — есть удобные средства внутри кабинета, проще использовать их, чем API.


Внутренняя структура шаблона весьма громоздкая, так что создание и редактирование шаблонов проще делать визуально, а не по API. 
А вот по API как раз выпуск карточек, просмотр всех выпущенных, поиск, статистика и другое.

Шаблоны, как и карточки, версионируются. Версии появляются, когда в интерфейсе меняешь свойства шаблона или дефолтные данные, и сохраняешь. 

У каждого шаблона есть **template_id**, который можно легко найти на вкладке "API" в интерфейсе.
