# card2b — API работы с карточками

Карточка — это то, что потребитель сможет установить на своё мобильное устройство по специальной ссылке.

Все экземпляры карточек наследуются от **шаблона** — идентификатор шаблона задаётся при создании карты и не может быть изменён со временем.
Каждый экземляр карты может переопределять некоторые значения относительно шаблона.

<a name="api_card_issue"></a>
## Выпуск новой карты
Вы можете выпускать карты как удобно: "на лету" при появлении нового потребителя или сгенерировать нужный объем заранее (с возможностью последующего обновления и персонализации).
После выпуска вы получите идентификатор созданой карточки и специальную ссылку для потребителя.

```shell
[POST] /api/card/issue
```

### Параметры запроса
* *POST* **template_id** *number* — идентификатор шаблона на основе которого выпускается карта;
* *POST* **override_data** *object* *optional* — переопределение параметров относительно шаблона в формате **key: value**;
Можно переопределять значения как пользовательских, так и [зарезервированных ключей](./override_data.md) 

Например:

```js
{
  "var_name": "new_value"
}
```
Все непереопределенные значения будут унаследованы от шаблонных **и изменяться вместе с изменениями шаблона**
(впоследствии их можно переопределить через обновление карточки)

### Параметры ответа
* **card_id** — идентификатор карты — служит для последующих операций над картой;
* **url** — ссылка на скачивание (установку) карты, её можно передавать клиенту

Пример ответа:

```js
{
  "card_id": 123,
  "url": "https://card2b.com/c/10148/ffbc60f02b1ae137"
}
```



<a name="api_card_get"></a>
## Запросить информацию о карте
Вы можете запросить любую выпущенную карту по её идентификатору, узнать её содержимое (сводные значения), сведенья о количестве установок, историю версий
```shell
[GET] /api/card/{card_id}
```

### Параметры запроса
* **card_id** *number* — идентификатор запрашиваемой карточки

### Параметры ответа
* [объект карточки](./working-with-api.md#card) — текущее состояние карточки, данные о количестве установок, список версий карты

Пример ответа
```js
{
  "card_id": 10148,
  "url": "https://card2b.com/c/10148/ffbc60f02b1ae137",
  "data": {
    "bonus": "10.00",
    "status": "Синий",
    "client_id": "12540",
    "owner_name": "Алексей"
  },
  "create_time": "2018-03-11T11:58:00.000Z",
  "update_time": "2018-03-12T12:53:00.000Z",
  "last_request_time": "2018-03-12T12:53:09.143Z",
  "n_installed": 1,
  "deactivated": false,
  "versions": [
    {
      "v_num": 1,
      "valid_from": "2018-03-11T11:58:00.000Z"
    },
    {
      "v_num": 2,
      "valid_from": "2018-03-12T12:53:00.000Z"
    }
  ]
} 
```


<a name="api_card_update"></a>
## Обновление данных карты
Изменение данных карточки может потребоваться в любой момент, например: обновился баланс, изменился номер посадочного терминала, появилось специальное предложение.
Обновление карточки доставляется на мобильное устройство клиента.
```shell
[POST] /api/card/{card_id}/update
```

### Параметры запроса
* **card_id** *number* — идентификатор изменяемой карточки
* *POST* **override_data** *object* — переопределение значений карты (одного или нескольких) относительно текущего состояния

> Внимание: Вы можете использовать `"var_name":null`, если хотите восстановить наследование значений от шаблона для параметра `var_name`


### Параметры ответа
* **card_id** *number* — идентификатор карточки
* **changed** *boolean* — статус изменения карточки. `true` если полученная `override_data` привела к изменению относительно текущего состояния карточки.

Пример ответа:

```js
{
  "card_id": 123,
  "changed": true
}
```


<a name="api_card_notify"></a>
## Отправка уведомления 
Владелец карточки получит push-уведомление с заданным текстом. Доступно только для установленных карточек `n_installed > 0`. 
```shell
[POST] /api/card/{card_id}/notify
```

### Параметры запроса
* **card_id** *number* — идентификатор карточки, на которую нужно отправить уведомление;
* *POST* **notify_text** *string* — текст уведомления.

### Параметры ответа
* **card_id** *number* — идентификатор карточки
* **changed** *boolean* — статус изменения карточки

> Ошибка в случае, если карта не установлена ни на одном устройстве

Пример ответа:

```js
{
  "card_id": 123,
  "changed": true
}
```



<a name="api_card_deactivate"></a>
## Блокирование карточки
Блокировка устанавливает запрет на скачивание и установку карточки.
```shell
[POST] /api/card/{card_id}/deactivate
```
Обновления и уведомления на уже установленую карточку будут отправляться в штатном режиме.
Например, можно оповестить пользователя о окончании действия его карты или отправить ссылку на новую карту.

### Параметры запроса
- **card_id** *number* — идентификатор блокируемой карточки

### Параметры ответа
* **card_id** *number* — идентификатор карточки
* **changed** *boolean* — статус изменения карточки (true, если карочка изменила свой статус)

Пример ответа:

```js
{
  "card_id": 123,
  "changed": true
}
```

<a name="api_card_activate"></a>
## Разблокирование карточки
Обратное действие к deactivate. После снятия блокировки карта вновь доступна для скачивания и устанавки.
```shell
[POST] /api/card/{card_id}/activate
```

### Параметры запроса
* **card_id** *number* — идентификатор карточки для разблокировки

### Параметры ответа
* **card_id** *number* — идентификатор карточки
* **changed** *boolean* — статус изменения карточки (true, если карочка изменила свой статус)

Пример ответа:

```js
{
  "card_id": 123,
  "changed": true
}
```

<a name="api_card_get_vtime"></a>
<a name="api_card_get_vnum"></a>
## Версии карточки
Каждое обновление карточки приводит к появлению новой версии.
Вы можете просматривать предыдущие состояния карточки запрашивая их по конкретному моменту времени или номеру версии.

```shell
[GET] /api/card/{card_id}?v_num={v_num}       # Для получения по номеру версии
```

### Параметры запроса
* **card_id** *number* — идентификатор запрашиваемой карточки
* **v_num** *number* — идентификатор запрашивоемой версии карточки

```shell
[GET] /api/card/{card_id}?v_time={v_time}       # Для получения на момент времени v_time
```

### Параметры запроса
* **card_id** *number* — идентификатор запрашиваемой карточки
* **v_time** *unix_timestamp* — момент времени, на который требуется узнать состояние

### Параметры ответа
* [объект версии карточки](./working-with-api.md#card-version).


<a name="api_card_stat"></a>
## Cтатистика изменения значения карточки
```shell
[GET] /api/card/{card_id}/stat?field={field}&timeFrom={timeFrom}&timeTo={timeTo}&step={step}
```
### Параметры запроса
- **card_id** *number* — id карточки
- **timeFrom** *unix timestamp* — с какого момента времени
- **timeTo** *unix timestamp* — до какого момента времени
- **field** *string* — ключ из *data* карточки; для нечисловых значений будет подставлен 0;
- **step** *number* — с каким шагом, в минутах

Пример: запросим, как менялся *bonus* у *123*-й карты с *28 февраля* по *11 марта* с шагом в *сутки*:

```shell
[GET] /api/card/123/stat?field=bonus&timeFrom=1519765200&timeTo=1520715600&step=1440
```  
### Параметры ответа

* **card_id** *number* — id карточки
* **field** *string* — ключ из *data* карточки; для нечисловых значений будет подставлен 0;
* **stepPoints** *array* — массив значений, которые принимал **field** на указанном отрезке времени;

Пример ответа:
```js
{
  "card_id": 123,
  "field": "bonus",
  "stepPoints": [0,2,2,2,0,0,0,0,0,8,8,3]
}
```
> Для построения агрегированой статистики по некоторому полю всех карточек шаблона (сумма значений, максимальный/минимальный значения и т.п.), воспользуйтесь главой
[статистика по шаблону](./templates.md#api_template_stat) 
